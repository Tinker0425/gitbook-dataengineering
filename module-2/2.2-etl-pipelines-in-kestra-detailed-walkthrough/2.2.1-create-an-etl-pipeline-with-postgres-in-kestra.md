---
icon: k
description: Last updated 1/26/25
---

# 2.2.1 - Create an ETL Pipeline with Postgres in Kestra

Youtube Video | \~28 min

{% embed url="https://youtu.be/OkfLX28Ecjg?si=vKbIyWo1TtjpNnvt" %}

{% hint style="info" %}
To get pgAdmin to connect, I use a docker-compose.yml that Bruno put in slack and then needed to modify one line in the video code...
{% endhint %}

{% stepper %}
{% step %}
### Docker-compose.yml

Open <mark style="background-color:blue;">Docker</mark> Desktop&#x20;

Add this docker-compose.yml from Bruno to your module-2 directory:

...add github

:black\_small\_square:Terminal head to the directory of your docker-compose.yml and run

```bash
docker compose up
```

:white\_check\_mark: Check that <mark style="background-color:purple;">Kestra</mark> 8080 and <mark style="background-color:yellow;">pgAdmin</mark> 9000 are running


{% endstep %}

{% step %}
### Build postgres\_taxi.yaml - View Empty Table in PgAdmin

<figure><img src="../../.gitbook/assets/Screen Shot 2025-01-26 at 9.15.38 AM.png" alt=""><figcaption></figcaption></figure>

Get used to using <mark style="background-color:purple;">Kestra</mark> and setting things up. I recommend writing this out, understand what it is doing, and then testing the run and output:

````yaml
id: postgres_taxi
namespace: zoomcamp

inputs:
  - id: taxi
    type: SELECT
    displayName: Select taxi type
    values: ['yellow','green']
    defaults: 'yellow'

  - id: year
    type: SELECT
    displayName: Pick Year
    values: ["2019","2020"]
    defaults: "2019"

  - id: month
    type: SELECT
    displayName: Pick Month
    values: ["01","02","03","04","05","06","07","08","09","10","11","12"]
    defaults: "01"

variables:
  file: "{{inputs.taxi}}_tripdata_{{inputs.year}}-{{inputs.month}}.csv"
  staging_table: "public.{{inputs.taxi}}_tripdata_staging"
  table: "public.{{inputs.taxi}}_tripdata"
  data: "{{outputs.extract.outputFiles[inputs.taxi ~ '_tripdata_' ~ inputs.year ~ '-' ~ inputs.month ~ '.csv']}}"


tasks:
  - id: set_label
    type: io.kestra.plugin.core.execution.Labels
    labels:
      file: "{{render(vars.file)}}"
      taxi: "{{inputs.taxi}}"

  - id: extract
    type: io.kestra.plugin.scripts.shell.Commands
    outputFiles:
      - "*.csv"
    taskRunner:
      type: io.kestra.plugin.core.runner.Process
    commands:
      - wget -qO- https://github.com/DataTalksClub/nyc-tlc-data/releases/download/{{inputs.taxi}}/{{render(vars.file)}}.gz | gunzip > {{render(vars.file)}}

  - id: green_create_table
    type: io.kestra.plugin.jdbc.postgresql.Queries
    sql: |
      CREATE TABLE IF NOT EXISTS {{render(vars.table)}} (
          unique_row_id          text,
          filename               text,
          VendorID               text,
          lpep_pickup_datetime   timestamp,
          lpep_dropoff_datetime  timestamp,
          store_and_fwd_flag     text,
          RatecodeID             text,
          PULocationID           text,
          DOLocationID           text,
          passenger_count        integer,
          trip_distance          double precision,
          fare_amount            double precision,
          extra                  double precision,
          mta_tax                double precision,
          tip_amount             double precision,
          tolls_amount           double precision,
          ehail_fee              double precision,
          improvement_surcharge  double precision,
          total_amount           double precision,
          payment_type           integer,
          trip_type              integer,
          congestion_surcharge   double precision
      );

  - id: green_create_staging_table
    type: io.kestra.plugin.jdbc.postgresql.Queries
    sql: |
      CREATE TABLE IF NOT EXISTS {{render(vars.staging_table)}} (
          unique_row_id          text,
          filename               text,
          VendorID               text,
          lpep_pickup_datetime   timestamp,
          lpep_dropoff_datetime  timestamp,
          store_and_fwd_flag     text,
          RatecodeID             text,
          PULocationID           text,
          DOLocationID           text,
          passenger_count        integer,
          trip_distance          double precision,
          fare_amount            double precision,
          extra                  double precision,
          mta_tax                double precision,
          tip_amount             double precision,
          tolls_amount           double precision,
          ehail_fee              double precision,
          improvement_surcharge  double precision,
          total_amount           double precision,
          payment_type           integer,
          trip_type              integer,
          congestion_surcharge   double precision
      );

pluginDefaults:
  - type: io.kestra.plugin.jdbc.postgresql
    values:
    url: jdbc:postgresql://kestra-metadata:5432/kestra
      username: kestra
      password: k3str4
```
````

{% hint style="info" %}
Line - url: jdbc:postgresql://kestra-metadata:5432/kestra was changed from video and github so we can use pgAdmin in our docker-compose and not have to download it locally.
{% endhint %}

<mark style="background-color:purple;">Kestra</mark>, save and execute - then open <mark style="background-color:yellow;">pgAdmin</mark> and add a new server connection:

![](<../../.gitbook/assets/Screen Shot 2025-01-26 at 11.17.38 AM.png>)

:white\_check\_mark: You should now see two empty green taxi tables in PgAdmin
{% endstep %}

{% step %}
### Build postgres\_taxi.yaml

1. Add to tasks the `green_create_staging_table` and re-run to see data added to the stagin table
2. Add to tasks `green_add_unique_id_and_filename` and re-run to see unique id's and filename columns updated
   1. :warning: This appends rows so we have duplicates, thus we need to Truncate our tables first:
3. Add to tasks `green_truncate_staging_table` after `green_create_staging_table`
4.







### &#x20;


{% endstep %}
{% endstepper %}









Ok at the start of the video he is already on 8080 kestra, so I am guess using the docker-compose.yml? From when I ran this earlier, it used postrgers version 17, so as long as it is later than 15 we should be good



### Directory Flow

```
├── flows/
│   ├── 01_getting_started_data_pipeline.yaml
│   ├── 02_postgres_taxi.yaml
│   ├── 02_postgres_taxi_scheduled.yaml
│   ├── 03_postgres_dbt.yaml
│   ├── 04_gcp_kv.yaml
│   ├── 05_gcp_setup.yaml
│   ├── 06_gcp_taxi.yaml
│   ├── 06_gcp_taxi_scheduled.yaml
│   └── 07_gcp_dbt.yaml
```







? Difference between '' and "" in kestra? Also, do I need to add the yml or are these the flows we re making? Ok, yeaah I think these are the flows we are making



To get the editor window, click 'Flows on the left hnd side -> 'Editor' tab -> 'Source and topography' as your file view option, similar to his in the video, ours should look like:





